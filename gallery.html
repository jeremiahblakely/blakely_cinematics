<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Gallery - Blakely Cinematics</title>
    <meta name="description" content="Private client gallery for Blakely Cinematics">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- Gallery-specific styles -->
    <style>
        .gallery-grid .empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.1rem;
            padding: 4rem 2rem;
            grid-column: 1 / -1;
        }
        
        img.placeholder { 
            filter: grayscale(1); 
            opacity: .7; 
        }
        
        .gallery-grid a {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .gallery-grid a img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
    
    <!-- AWS CloudWatch RUM Analytics -->
    <script>
      (function(n,i,v,r,s,c,x,z){x=window.AwsRumClient={q:[],n:i,i:i,v:v,r:r,c:c};window[n]=function(c,p){x.q.push({c:c,p:p});};z=document.createElement('script');z.async=true;z.src=s;document.head.insertBefore(z,document.head.getElementsByTagName('script')[0]);})(
        'cwr',
        '1a163e06-eb6a-4131-bdb1-6e27fbb0799c',
        '1.0.0',
        'us-east-1',
        'https://client.rum.us-east-1.amazonaws.com/1.19.0/cwr.js',
        {
          sessionSampleRate: 1 ,
          endpoint: "https://dataplane.rum.us-east-1.amazonaws.com" ,
          telemetries: ["performance","errors","http"] ,
          allowCookies: true ,
          enableXRay: false ,
          signing: true
        }
      );
    </script>
</head>
<body class="gallery-page">
    <!-- Custom Cursor -->
    <div class="cursor"></div>
    <div class="cursor-follower"></div>
    
    <!-- Minimal Navigation -->
    <nav class="gallery-nav">
        <div class="nav-container">
            <a href="index.html" class="logo">BLAKELY</a>
            <a href="vip.html" class="sign-out-link">Sign Out</a>
        </div>
    </nav>
    
    <!-- Gallery Header -->
    <section class="gallery-header">
        <div class="gallery-header-content">
            <div class="client-info">
                <h1 class="client-name">Sarah Johnson - Headshots</h1>
                <div class="session-details">
                    <span class="session-date">August 2025</span>
                    <span class="image-count">24 images available</span>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Gallery Actions -->
    <section class="gallery-actions">
        <div class="actions-container">
            <div class="selection-controls">
                <button class="action-btn select-all-btn">Select All</button>
                <button class="action-btn clear-selection-btn">Clear Selection</button>
                <span class="selected-count">0 selected</span>
            </div>
            
            <div class="download-controls">
                <button class="download-btn btn btn-primary" disabled>
                    Download Selected
                </button>
            </div>
        </div>
    </section>
    
    <!-- Photo Gallery Grid -->
    <section class="photo-gallery">
        <div class="gallery-grid" id="gallery-grid">
            <!-- Placeholder images - will be generated by JavaScript -->
        </div>
    </section>
    
    <!-- Gallery Footer -->
    <footer class="gallery-footer">
        <div class="footer-container">
            <p>&copy; 2024 Blakely Cinematics. All rights reserved. | Private gallery for authorized clients only.</p>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script>
        // Gallery functionality
        class ClientGallery {
            constructor() {
                this.selectedImages = new Set();
                this.totalImages = 12; // For demo purposes
                this.galleryInfo = null;
                this.init();
            }
            
            init() {
                // Check authentication first
                if (!this.checkAuthentication()) {
                    return; // Will redirect, so don't continue initialization
                }
                
                this.loadGalleryInfo();
                this.bindEvents();
                this.updateSelectedCount();
                this.loadGalleryImages(); // Load real images from API
            }
            
            checkAuthentication() {
                const isAuthenticated = sessionStorage.getItem('authenticated');
                if (!isAuthenticated || isAuthenticated !== 'true') {
                    console.log('üö´ Not authenticated - redirecting to VIP login');
                    window.location.href = 'vip.html';
                    return false;
                }
                return true;
            }
            
            loadGalleryInfo() {
                const galleryInfoStr = sessionStorage.getItem('galleryInfo');
                if (galleryInfoStr) {
                    this.galleryInfo = JSON.parse(galleryInfoStr);
                    console.log('üìã Gallery info loaded:', this.galleryInfo);
                    this.displayClientInfo();
                }
            }
            
            displayClientInfo() {
                if (this.galleryInfo) {
                    // Update client name and session type
                    const clientNameEl = document.querySelector('.client-name');
                    if (clientNameEl) {
                        clientNameEl.textContent = `${this.galleryInfo.clientName} - ${this.galleryInfo.sessionType}`;
                    }
                    
                    // Update session date if available
                    const sessionDateEl = document.querySelector('.session-date');
                    if (sessionDateEl && this.galleryInfo.sessionDate) {
                        sessionDateEl.textContent = this.galleryInfo.sessionDate;
                    }
                    
                    // Update image count if available
                    const imageCountEl = document.querySelector('.image-count');
                    if (imageCountEl && this.galleryInfo.imageCount) {
                        this.totalImages = this.galleryInfo.imageCount;
                        imageCountEl.textContent = `${this.totalImages} images available`;
                    }
                }
            }
            
            async loadGalleryImages() {
                try {
                    // Get gallery info from session
                    const galleryInfo = JSON.parse(sessionStorage.getItem('galleryInfo') || '{}');
                    const galleryCode = galleryInfo.galleryCode || sessionStorage.getItem('galleryCode') || 'DEMO2025';
                    
                    console.log('üì∏ Loading gallery images for code:', galleryCode);
                    
                    // Show loading state
                    const container = document.querySelector("#gallery-grid");
                    container.innerHTML = '<div class="loading-message">Loading images...</div>';
                    
                    // Use the new fetchGalleryImages function
                    const imgs = await fetchGalleryImages(galleryCode);
                    console.log('üñºÔ∏è Loaded images:', imgs);
                    
                    if (imgs.length > 0) {
                        // Option 1: Use existing complex display method (current)
                        this.displayImages(imgs);
                        this.updateImageCount(imgs.length);
                        
                        // Option 2: Simple image display (alternative)
                        // container.innerHTML = '';
                        // imgs.forEach(({ url }) => {
                        //   if (!url) return;
                        //   const img = document.createElement("img");
                        //   img.loading = "lazy";
                        //   img.decoding = "async";
                        //   img.src = url;
                        //   img.style.cssText = "width: 100%; height: auto; margin-bottom: 1rem;";
                        //   container.appendChild(img);
                        // });
                    } else {
                        console.log('‚ö†Ô∏è No images found, creating placeholder grid');
                        this.createPlaceholderGrid();
                    }
                } catch (error) {
                    console.error('üö® Error loading images:', error);
                    this.createPlaceholderGrid();
                }
            }
            
            displayImages(images = []) {
                const grid = document.querySelector('.gallery-grid');
                grid.innerHTML = '';

                if (!Array.isArray(images) || images.length === 0) {
                    grid.innerHTML = `<p class="empty">No images yet‚Äîcheck back soon.</p>`;
                    return;
                }

                this.totalImages = images.length;
                const frag = document.createDocumentFragment();

                images.forEach((item, index) => {
                    // Create wrapper for gallery functionality (checkboxes, etc.)
                    const imageBox = document.createElement('div');
                    imageBox.className = 'gallery-image';
                    imageBox.dataset.imageId = item.imageId || `img-${index + 1}`;

                    // Create clickable link to full image
                    const a = document.createElement('a');
                    a.href = item.url;                 // full presigned URL
                    a.target = '_blank';
                    a.rel = 'noopener';

                    const img = document.createElement('img');
                    img.src = item.url;
                    img.alt = item.imageId || 'Photo';
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    img.referrerPolicy = 'no-referrer';    // extra safety; optional
                    img.className = 'gallery-img';

                    // Fallback if URL fails (expired/missing)
                    img.onerror = () => {
                        img.onerror = null;
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIFVuYXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';
                        img.classList.add('placeholder');
                    };

                    // Maintain existing gallery selection functionality
                    const overlay = document.createElement('div');
                    overlay.className = 'image-overlay';
                    overlay.innerHTML = `<span class="image-number">${item.imageId || item.fileName || `IMG-${String(index + 1).padStart(3, '0')}`}</span>`;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'image-checkbox';
                    checkbox.id = `img-${index + 1}`;

                    const label = document.createElement('label');
                    label.htmlFor = `img-${index + 1}`;
                    label.className = 'checkbox-label';

                    // Build the structure
                    const container = document.createElement('div');
                    container.className = 'image-container';
                    
                    a.appendChild(img);
                    container.appendChild(a);
                    container.appendChild(overlay);
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    
                    imageBox.appendChild(container);
                    frag.appendChild(imageBox);
                });

                grid.appendChild(frag);
                console.log(`‚úÖ Displayed ${images.length} images`);
            }
            
            updateImageCount(count) {
                if (count !== undefined) {
                    this.totalImages = count;
                    const imageCountEl = document.querySelector('.image-count');
                    if (imageCountEl) {
                        imageCountEl.textContent = `${count} images available`;
                    }
                }
            }
            
            createPlaceholderGrid() {
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                
                for (let i = 1; i <= this.totalImages; i++) {
                    const imageBox = document.createElement('div');
                    imageBox.className = 'gallery-image';
                    imageBox.dataset.imageId = `IMG-${String(i).padStart(3, '0')}`;
                    
                    imageBox.innerHTML = `
                        <div class="image-placeholder">
                            <div class="image-overlay">
                                <span class="image-number">IMG-${String(i).padStart(3, '0')}</span>
                            </div>
                            <input type="checkbox" class="image-checkbox" id="img-${i}">
                            <label for="img-${i}" class="checkbox-label"></label>
                        </div>
                    `;
                    
                    grid.appendChild(imageBox);
                }
                
                console.log(`üìã Created ${this.totalImages} placeholder images`);
            }
            
            bindEvents() {
                // Individual image selection
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('image-checkbox')) {
                        this.toggleImageSelection(e.target);
                    }
                });
                
                // Select all button
                document.querySelector('.select-all-btn').addEventListener('click', () => {
                    this.selectAll();
                });
                
                // Clear selection button
                document.querySelector('.clear-selection-btn').addEventListener('click', () => {
                    this.clearSelection();
                });
                
                // Download button
                document.querySelector('.download-btn').addEventListener('click', () => {
                    this.downloadSelected();
                });
            }
            
            toggleImageSelection(checkbox) {
                const imageId = checkbox.id.replace('img-', '');
                const imageBox = checkbox.closest('.gallery-image');
                
                if (checkbox.checked) {
                    this.selectedImages.add(imageId);
                    imageBox.classList.add('selected');
                    console.log(`Selected: IMG-${String(imageId).padStart(3, '0')}`);
                } else {
                    this.selectedImages.delete(imageId);
                    imageBox.classList.remove('selected');
                    console.log(`Deselected: IMG-${String(imageId).padStart(3, '0')}`);
                }
                
                this.updateSelectedCount();
            }
            
            selectAll() {
                const checkboxes = document.querySelectorAll('.image-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const imageId = checkbox.id.replace('img-', '');
                    this.selectedImages.add(imageId);
                    checkbox.closest('.gallery-image').classList.add('selected');
                });
                
                this.updateSelectedCount();
                console.log('Selected all images');
            }
            
            clearSelection() {
                const checkboxes = document.querySelectorAll('.image-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('.gallery-image').classList.remove('selected');
                });
                
                this.selectedImages.clear();
                this.updateSelectedCount();
                console.log('Cleared all selections');
            }
            
            updateSelectedCount() {
                const count = this.selectedImages.size;
                const countElement = document.querySelector('.selected-count');
                const downloadBtn = document.querySelector('.download-btn');
                
                countElement.textContent = `${count} selected`;
                
                if (count > 0) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = `Download Selected (${count})`;
                } else {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'Download Selected';
                }
            }
            
            downloadSelected() {
                if (this.selectedImages.size === 0) {
                    alert('Please select images to download');
                    return;
                }
                
                const selectedList = Array.from(this.selectedImages).map(id => 
                    `IMG-${String(id).padStart(3, '0')}`
                );
                
                console.log('üîΩ Download request for:', selectedList);
                alert(`Download request sent for ${this.selectedImages.size} images. You will receive a download link via email shortly.`);
            }
        }
        
        // Sign out functionality
        function handleSignOut() {
            console.log('üö™ Signing out - clearing session storage');
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('galleryInfo');
            window.location.href = 'vip.html';
        }
        
        // Initialize gallery when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize custom cursor and other components
            if (typeof initCustomCursor === 'function') {
                initCustomCursor();
            }
            
            // Bind sign out event
            const signOutLink = document.querySelector('.sign-out-link');
            if (signOutLink) {
                signOutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleSignOut();
                });
            }
            
            // Initialize gallery
            new ClientGallery();
        });
    </script>
    
    <!-- Load main script for shared functionality -->
    <script src="/js/script.js"></script>
</body>
</html>
